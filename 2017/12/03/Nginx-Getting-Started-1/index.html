<!DOCTYPE html>
<!--[if lte IE 8 ]>
<html class="ie" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<![endif]-->
<!--[if (gte IE 9)|!(IE)]><!-->
<!--
***************  *      *     *
      8          *    *       *
      8          *  *         *
      8          **           *
      8          *  *         *
      8          *    *       *
      8          *      *     *
      8          *        *   ***********    -----Theme By Kieran(http://go.kieran.top)
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<!--<![endif]-->

<head>
  <title>Nginx 基础入门 | Thpffcj的树洞</title>
  <!-- Meta data -->
    <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" >
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="generator" content="Hexo">
    <meta name="author" content="John Doe">
    <meta name="description" content="" />
    <meta name="keywords" content="" />

    <!-- Favicon, (keep icon in root folder) -->
    <link rel="Shortcut Icon" href="/img/favicon.ico" type="image/ico">

    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
    <link rel="stylesheet" href="/css/all.css" media="screen" type="text/css">
    
    <link rel="stylesheet" href="/highlightjs/vs.css" type="text/css">
    

    <!--[if IE 8]>
    <link rel="stylesheet" type="text/css" href="/css/ie8.css" />
    <![endif]-->

    <!-- jQuery | Load our jQuery, with an alternative source fallback to a local version if request is unavailable -->
    <script src="/js/jquery-1.11.1.min.js"></script>
    <script>window.jQuery || document.write('<script src="js/jquery-1.11.1.min.js"><\/script>')</script>

    <!-- Load these in the <head> for quicker IE8+ load times -->
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="/js/html5shiv.min.js"></script>
    <script src="/js/respond.min.js"></script>
    <![endif]-->

  
  
  

  <style>.col-md-8.col-md-offset-2.opening-statement img{display:none;}</style>
</head>

<!--
<body class="post-template">
-->
<body id="index" class="lightnav animsition">

      <!-- ============================ Off-canvas navigation =========================== -->

    <div class="sb-slidebar sb-right sb-style-overlay sb-momentum-scrolling">
        <div class="sb-close" aria-label="Close Menu" aria-hidden="true">
            <img src="/img/close.png" alt="Close">
        </div>
        <!-- Lists in Slidebars -->
        <ul class="sb-menu">
            <li><a href="/" class="animsition-link" title="Home">Home</a></li>
            <li><a href="/archives" class="animsition-link" title="archive">archives</a></li>
            <!-- Dropdown Menu -->
			 
            <li>
                <a class="sb-toggle-submenu">Works<span class="sb-caret"></span></a>
                <ul class="sb-submenu">
                    
                        <li><a href="/" target="_BLANK" class="animsition-link">AAA</a></li>
                    
                        <li><a href="/atom.xml" target="_BLANK" class="animsition-link">BBB</a></li>
                    
                </ul>
            </li>
            
            
            
            <li>
                <a class="sb-toggle-submenu">Links<span class="sb-caret"></span></a>
                <ul class="sb-submenu">
                    
                    <li><a href="http://go.kieran.top/" class="animsition-link">Kieran</a></li>
                    
                    <li><a href="http://domain.com/" class="animsition-link">Name</a></li>
                    
                </ul>
            </li>
            
        </ul>
        <!-- Lists in Slidebars -->
        <ul class="sb-menu secondary">
            <li><a href="/about.html" class="animsition-link" title="about">About</a></li>
            <li><a href="/atom.xml" class="animsition-link" title="rss">RSS</a></li>
        </ul>
    </div>
    
    <!-- ============================ END Off-canvas navigation =========================== -->

    <!-- ============================ #sb-site Main Page Wrapper =========================== -->

    <div id="sb-site">
        <!-- #sb-site - All page content should be contained within this id, except the off-canvas navigation itself -->

        <!-- ============================ Header & Logo bar =========================== -->

        <div id="navigation" class="navbar navbar-fixed-top">
            <div class="navbar-inner">
                <div class="container">
                    <!-- Nav logo -->
                    <div class="logo">
                        <a href="/" title="Logo" class="animsition-link">
                         <img src="/img/logo.png" alt="Logo" width="35px;"> 
                        </a>
                    </div>
                    <!-- // Nav logo -->
                    <!-- Info-bar -->
                    <nav>
                        <ul class="nav">
                            <li><a href="/" class="animsition-link">Thpffcj</a></li>
                            <li class="nolink"><span>Always </span>Creative.</li>
                            
                            <li><a href="https://github.com/" title="Github" target="_blank"><i class="icon-github"></i></a></li>
                            
                            
                            <li><a href="https://twitter.com/" title="Twitter" target="_blank"><i class="icon-twitter"></i></a></li>
                            
                            
                            <li><a href="https://www.facebook.com/" title="Facebook" target="_blank"><i class="icon-facebook"></i></a></li>
                            
                            
                            <li><a href="https://google.com/" title="Google-Plus" target="_blank"><i class="icon-google-plus"></i></a></li>
                            
                            
                            <li><a href="http://weibo.com/" title="Sina-Weibo" target="_blank"><i class="icon-sina-weibo"></i></a></li>
                            
                            <li class="nolink"><span>Welcome!</span></li>
                        </ul>
                    </nav>
                    <!--// Info-bar -->
                </div>
                <!-- // .container -->
                <div class="learnmore sb-toggle-right">More</div>
                <button type="button" class="navbar-toggle menu-icon sb-toggle-right" title="More">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar before"></span>
                <span class="icon-bar main"></span>
                <span class="icon-bar after"></span>
                </button>
            </div>
            <!-- // .navbar-inner -->
        </div>

        <!-- ============================ Header & Logo bar =========================== -->

</div>
      
<section id="intro">
    <div class="container">
        <div class="row col-md-offset-2">
            <div class="col-md-8">
    			<span class="post-meta">
      <time datetime="2017-12-03T12:53:52.000Z" itemprop="datePublished">
          2017-12-03
      </time>
    
</span>
                <h1>Nginx 基础入门</h1>
            </div>
        </div>
        <div class="col-md-8 col-md-offset-2">
      		<p>Nginx是一个高效可靠的Web服务和代理中间件，在放假之前我想系统了解一下Nginx的各种技术。这里是第一篇记录，主要了解一下Nginx的一些基础知识。</p>
<hr>
<h2 id="1-Nginx的快速部署安装"><a href="#1-Nginx的快速部署安装" class="headerlink" title="1. Nginx的快速部署安装"></a>1. Nginx的快速部署安装</h2><h3 id="1-环境调试确认"><a href="#1-环境调试确认" class="headerlink" title="1. 环境调试确认"></a>1. 环境调试确认</h3><ul>
<li>四项确认<ul>
<li>确认系统网络</li>
<li>确认yum可用</li>
<li>确认关闭iptables规则</li>
<li>确认停用selinux</li>
</ul>
</li>
<li>两项安装<ul>
<li>yum -y install gcc gcc-c++ autoconf pcre pcre-devel make antomake</li>
<li>yum -y install wget httpd-tools vim</li>
</ul>
</li>
<li>一次初始化<ul>
<li>cd /opt; mkdir app download logs work backup</li>
</ul>
</li>
<li>确认系统网络，能ping通说明没有问题</li>
</ul>
<pre><code>[thpffcj@thpffcj ~]$$ ping www.baidu.com
</code></pre><ul>
<li>确认yum可用，有对应信息说明yum源可用</li>
</ul>
<pre><code>[thpffcj@thpffcj ~]$ yum list | grep gcc
</code></pre><ul>
<li>确认关闭iptables规则，-L查看，-F关闭</li>
</ul>
<pre><code>[root@thpffcj thpffcj]# iptables -L
[root@thpffcj thpffcj]# iptables -F
[root@thpffcj thpffcj]# iptables -t nat -F
</code></pre><ul>
<li>确认停用selinux</li>
</ul>
<pre><code>[root@thpffcj thpffcj]# getenforce
[root@thpffcj thpffcj]# setenforce 0
</code></pre><ul>
<li>安装基础依赖</li>
</ul>
<pre><code>[root@thpffcj thpffcj]# yum -y install gcc-c++ autoconf pcre pcre-devel make automake

[root@thpffcj thpffcj]# yum -y install wget httpd-tools vim
</code></pre><ul>
<li>初始化系统目录</li>
</ul>
<pre><code>[thpffcj@thpffcj ~]$ pwd
/home/thpffcj

[thpffcj@thpffcj ~]$ mkdir app
[thpffcj@thpffcj ~]$ mkdir backup
[thpffcj@thpffcj ~]$ mkdir download
[thpffcj@thpffcj ~]$ mkdir logs
[thpffcj@thpffcj ~]$ mkdir work
</code></pre><p><br></p>
<hr>
<h2 id="2-Nginx简述"><a href="#2-Nginx简述" class="headerlink" title="2. Nginx简述"></a>2. Nginx简述</h2><p><strong>Nginx是一个开源且高性能，可靠的HTTP中间件，代理服务</strong></p>
<h3 id="1-为什么选择Nginx"><a href="#1-为什么选择Nginx" class="headerlink" title="1. 为什么选择Nginx"></a>1. 为什么选择Nginx</h3><p><strong>1. IO多路复用epoll</strong></p>
<ul>
<li>让一个Socket作为复用完成整个IO流的请求</li>
<li>什么是IO多路复用<ul>
<li>多个描述符的IO操作都能在一个线程内并发交替地顺序完成，这就叫IO多路复用，这里的”复用”指的是复用同一个线程。</li>
</ul>
</li>
<li>什么是epoll<ul>
<li>IO多路复用的实现方式select，poll，epoll。</li>
<li>select缺点：<ul>
<li>能够监视文件描述符的数量存在最大限制。</li>
<li>线性扫描效率低下。</li>
</ul>
</li>
<li>epoll模型：<ul>
<li>每当FD就绪，采用系统的回调函数直接将fd放入，效率更高。</li>
<li>最大连接数无限制。</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><strong>2. 轻量级</strong></p>
<ul>
<li>功能模块少</li>
<li>代码模块少</li>
</ul>
<p><strong>3. CPU亲和(affinity)</strong></p>
<ul>
<li>什么是CPU亲和<ul>
<li>是一种把CPU核心和Nginx工作进程绑定方式，把每个worker进程固定在一个CPU上执行，减少切换CPU的chche miss，获得更好的性能</li>
</ul>
</li>
</ul>
<p><strong>4. sendfile</strong></p>
<ul>
<li>文件的传输只通过内核空间传输给用户，而不经过用户空间</li>
</ul>
<h3 id="2-Nginx安装"><a href="#2-Nginx安装" class="headerlink" title="2. Nginx安装"></a>2. Nginx安装</h3><ul>
<li>在机器的yum源上新建一个nginx.repo</li>
</ul>
<pre><code>[root@thpffcj yum.repos.d]# vim /etc/yum.repos.d/nginx.repo
</code></pre><ul>
<li>将我们在官网上复制的yum信息拷贝到文件中</li>
</ul>
<pre><code>[nginx]
name=nginx repo
baseurl=http://nginx.org/packages/centos/7/$basearch/
gpgcheck=0
enabled=1
</code></pre><ul>
<li>快速安装</li>
</ul>
<pre><code>[root@thpffcj nginx]# yum install nginx
</code></pre><h3 id="3-基本参数使用"><a href="#3-基本参数使用" class="headerlink" title="3. 基本参数使用"></a>3. 基本参数使用</h3><ul>
<li>列出安装服务的安装目录和配置文件等信息</li>
</ul>
<pre><code>[root@thpffcj nginx]# rpm -ql nginx
</code></pre><p><strong>1. 安装目录讲解</strong></p>
<ul>
<li>路径：/etc/logrotate.d/nginx </li>
<li>类型：配置文件</li>
<li>作用：Nginx日志轮转，用于logrotate服务的日志切割</li>
</ul>
<ul>
<li>路径：<ul>
<li>/etc/nginx </li>
<li>/etc/nginx/nginx.conf </li>
<li>/etc/nginx/conf.d </li>
<li>/etc/nginx/conf.d/default.conf</li>
</ul>
</li>
<li>类型：目录，配置文件</li>
<li>作用：Nginx主配置文件</li>
</ul>
<ul>
<li>路径：<ul>
<li>/etc/nginx/fastcgi_params</li>
<li>/etc/nginx/uwsgi_params</li>
<li>/etc/nginx/scgi_params</li>
</ul>
</li>
<li>类型：配置文件</li>
<li>作用：cgi配置相关，fashcgi配置</li>
</ul>
<ul>
<li>路径：<ul>
<li>/etc/nginx/koi-utf</li>
<li>/etc/nginx/koi-win</li>
<li>/etc/nginx/win-utf</li>
</ul>
</li>
<li>类型：配置文件</li>
<li>作用：编码转换映射转化文件</li>
</ul>
<ul>
<li>路径：/etc/nginx/mime.types</li>
<li>类型：配置文件</li>
<li>作用：设置http协议的Content-Type与扩展名对应关系</li>
</ul>
<ul>
<li>路径：<ul>
<li>/usr/lib/systemd/system/nginx-debug.service</li>
<li>/usr/lib/systemd/system/nginx.service</li>
<li>/etc/sysconfig/nginx</li>
<li>/etc/sysconfig/nginx-debug</li>
</ul>
</li>
<li>类型：配置文件</li>
<li>作用：用于配置出系统守护进程管理器管理方式</li>
</ul>
<ul>
<li>路径：<ul>
<li>/usr/lib64/nginx/modules</li>
<li>/etc/nginx/modules</li>
</ul>
</li>
<li>类型：目录</li>
<li>作用：Nginx模块目录</li>
</ul>
<ul>
<li>路径：<ul>
<li>/usr/sbin/nginx</li>
<li>/usr/sbin/nginx-debug</li>
</ul>
</li>
<li>类型：命令</li>
<li>作用：Nginx服务的启动管理的终端命令</li>
</ul>
<ul>
<li>路径：<ul>
<li>/usr/share/doc/nginx-1.12.0</li>
<li>/usr/share/doc/nginx-1.12.0/COPYRIGHT</li>
<li>/usr/share/man/man8/nginx.8.gz</li>
</ul>
</li>
<li>类型：文件，目录</li>
<li>作用：Nginx的手册和帮助文档</li>
</ul>
<ul>
<li>路径：/var/cache/nginx</li>
<li>类型：目录</li>
<li>作用：Nginx的缓存目录</li>
</ul>
<ul>
<li>路径：/var/log/nginx</li>
<li>类型：目录</li>
<li>作用：Nginx的日志目录</li>
</ul>
<p><strong>2. 安装编译参数</strong></p>
<ul>
<li>使用命令 nginx -V，我们来看显示的一部分编译参数</li>
</ul>
<ul>
<li>编译选项<ul>
<li>–prefix=/etc/nginx </li>
<li>–sbin-path=/usr/sbin/nginx </li>
<li>–modules-path=/usr/lib64/nginx/modules </li>
<li>–conf-path=/etc/nginx/nginx.conf </li>
<li>–error-log-path=/var/log/nginx/error.log </li>
<li>–http-log-path=/var/log/nginx/access.log </li>
<li>–pid-path=/var/run/nginx.pid </li>
<li>–lock-path=/var/run/nginx.lock</li>
</ul>
</li>
<li>作用：安装目的目录或路径</li>
</ul>
<ul>
<li>编译选项<ul>
<li>–http-client-body-temp-path=/var/cache/nginx/client_temp –http-proxy-temp-path=/var/cache/nginx/proxy_temp </li>
<li>–http-fastcgi-temp-path=/var/cache/nginx/fastcgi_temp </li>
<li>–http-uwsgi-temp-path=/var/cache/nginx/uwsgi_temp </li>
<li>–http-scgi-temp-path=/var/cache/nginx/scgi_temp</li>
</ul>
</li>
<li>作用：执行对应模块时，Nginx所保留的临时性文件</li>
</ul>
<ul>
<li>编译选项<ul>
<li>–user=nginx </li>
<li>–group=nginx</li>
</ul>
</li>
<li>作用：设定Nginx进程启动的用户和组用户</li>
</ul>
<ul>
<li>编译选项<ul>
<li>–with-cc-opt=’-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong</li>
</ul>
</li>
<li>作用：设置额外的参数将别添加到CFLAGS变量</li>
</ul>
<ul>
<li>编译选项<ul>
<li>–with-ld-opt=’-Wl,-z,relro -Wl,-z,now -pie’</li>
</ul>
</li>
<li>作用：设置附加的参数，链接系统库</li>
</ul>
<h3 id="4-Nginx的目录和配置语法"><a href="#4-Nginx的目录和配置语法" class="headerlink" title="4. Nginx的目录和配置语法"></a>4. Nginx的目录和配置语法</h3><ul>
<li>进入nginx主目录看一下conf里的一些配置</li>
</ul>
<pre><code>[root@thpffcj thpffcj]# cd /etc/nginx/
[root@thpffcj nginx]# ls
conf.d          koi-utf  mime.types  nginx.conf   uwsgi_params
fastcgi_params  koi-win  modules     scgi_params  win-utf
</code></pre><ul>
<li>查看自己主机ip</li>
</ul>
<pre><code>[root@thpffcj nginx]# ip a
</code></pre><ul>
<li>启动nginx和重启nginx</li>
</ul>
<pre><code>[root@thpffcj nginx]# systemctl start nginx

[root@thpffcj nginx]# systemctl restart nginx.service
</code></pre><h3 id="5-主要配置学习"><a href="#5-主要配置学习" class="headerlink" title="5. 主要配置学习"></a>5. 主要配置学习</h3><p><strong>1. HTTP请求</strong></p>
<ul>
<li>request - 包括请求行，请求头部，请求数据</li>
<li><p>response - 包括状态行，消息报头，响应正文</p>
</li>
<li><p>模拟请求</p>
</li>
</ul>
<pre><code>[root@thpffcj nginx]# curl https://www.imooc.com
</code></pre><ul>
<li>我们可以使用-v来展现请求的信息内容，并重定向到一个空设备上，我们可以看见request和response的相关信息</li>
</ul>
<pre><code>[root@thpffcj nginx]# curl -v https://www.imooc.com &gt; /dev/null

&gt; GET / HTTP/1.1
&gt; User-Agent: curl/7.29.0
&gt; Host: www.imooc.com
&gt; Accept: */*

&lt; HTTP/1.1 200 OK
&lt; Server: nginx
&lt; Date: Mon, 04 Dec 2017 11:54:29 GMT
&lt; Content-Type: text/html; charset=utf-8
</code></pre><p><strong>2. Nginx日志类型</strong></p>
<ul>
<li>包括：<ul>
<li>error_log </li>
<li>access_log</li>
</ul>
</li>
<li><p>通过log_format实现</p>
</li>
<li><p>我们看一下nginx的log配置</p>
</li>
</ul>
<pre><code>[root@thpffcj nginx]# vi /etc/nginx/nginx.conf 

error_log  /var/log/nginx/error.log warn;
</code></pre><ul>
<li>最后的warn是错误日志的级别，我们可以根据自己的需要进行调整，我们目前还没有错误日志</li>
</ul>
<pre><code>[root@thpffcj nginx]# tail -f /var/log/nginx/error.log 
</code></pre><ul>
<li>access_log后面也是存放路径，main是nginx的log_format的名字，表示以main的格式要求记录到access_log里面</li>
</ul>
<pre><code>log_format  main  &apos;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &apos;
                  &apos;$status $body_bytes_sent &quot;$http_referer&quot; &apos;
                  &apos;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&apos;;

access_log  /var/log/nginx/access.log  main;
</code></pre><ul>
<li>$接字符串就表示nginx的变量，每个变量通过一定的符号连接在一起，就组成了一定的格式要求</li>
</ul>
<p><strong>3. Nginx变量</strong></p>
<ul>
<li>HTTP请求变量：arg_PAERAMETER，http_HEADER，sent_http_HEADER</li>
<li>内置变量：Nginx内置的</li>
<li><p>自定义变量：自己定义</p>
</li>
<li><p>比如我们想要记录用户的user_agent，我想要在nginx的日志里打印出来，我们编辑nginx.conf，在最前面加入http_user_agent</p>
</li>
</ul>
<pre><code>log_format  main  &apos;$http_user_agent&apos;
                  &apos;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &apos;
                  &apos;$status $body_bytes_sent &quot;$http_referer&quot; &apos;
                  &apos;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&apos;;

access_log  /var/log/nginx/access.log  main;
</code></pre><ul>
<li>检查配置语法是否正确</li>
</ul>
<pre><code>[root@thpffcj nginx]# nginx -t -c nginx.conf 
nginx: the configuration file /etc/nginx/nginx.conf syntax is ok
nginx: configuration file /etc/nginx/nginx.conf test is successful
</code></pre><ul>
<li>重启nginx服务器</li>
</ul>
<pre><code>[root@thpffcj nginx]# nginx -s reload -c nginx.conf
</code></pre><ul>
<li>然后我们请求本机，并查看access.log</li>
</ul>
<pre><code>[root@thpffcj nginx]# curl http://127.0.0.1

[root@thpffcj nginx]# tail -f /var/log/nginx/access.log
curl/7.29.0127.0.0.1 - - [27/Dec/2017:20:16:42 +0800] &quot;GET / HTTP/1.1&quot; 404 169 &quot;-&quot; &quot;curl/7.29.0&quot; &quot;-&quot;
</code></pre><p><strong>4. Nginx默认log-format</strong></p>
<pre><code>log_format main &apos;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &apos;
                &apos;$status $body_bytes_sent &quot;$http_referer&quot; &apos;
                &apos;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&apos;;
</code></pre><ul>
<li>remote_addr是客户端的地址</li>
<li>remote_user是HTTP用户端客户端请求nginx认证的用户名</li>
<li>time_local指nginx的时间</li>
<li>request表示request头的请求行</li>
<li>status表示response返回的状态</li>
<li>body_bytes_sent指从服务端响应给客户端这个body信息里面的大小</li>
<li>http_referer在防盗链里和对用户行为分析的时候会经常用到，这是标准HTTP协议携带的一个头，referer指上一级页面是哪一个。</li>
<li>http_user_agent也是标准HTTP的头信息，user_agent指客户端的内容。</li>
<li>http_x_forwarded_for也是标准HTTP的头信息，会记录每一级用户通过HTTP里所携带的HTTP信息。</li>
</ul>
<h3 id="6-Nginx模块"><a href="#6-Nginx模块" class="headerlink" title="6. Nginx模块"></a>6. Nginx模块</h3><ul>
<li>Nginx官方模块</li>
<li><p>第三方模块</p>
</li>
<li><p>使用nginx -V可以看到编译的模块</p>
</li>
</ul>
<pre><code>[root@thpffcj nginx]# nginx -V

--with-compat --with-file-aio --with-threads --with-http_addition_module --with-http_auth_request_module --with-http_dav_module --with-http_flv_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_mp4_module --with-http_random_index_module --with-http_realip_module --with-http_secure_link_module --with-http_slice_module --with-http_ssl_module --with-http_stub_status_module --with-http_sub_module --with-http_v2_module --with-mail --with-mail_ssl_module --with-stream --with-stream_realip_module --with-stream_ssl_module --with-stream_ssl_preread_module
</code></pre><p><strong>安装编译参数讲解</strong></p>
<table>
<thead>
<tr>
<th style="text-align:left">编译选项</th>
<th style="text-align:left">&nbsp;&nbsp;作用</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">–with-http_stub_status_module</td>
<td style="text-align:left">&nbsp;&nbsp;Nginx 的客户端状态</td>
</tr>
</tbody>
</table>
<p><strong>语法</strong></p>
<pre><code>Syntax: stub_status;
Default: -
Context: server, location
</code></pre><ul>
<li>我们添加配置一个location</li>
</ul>
<pre><code>[root@thpffcj conf.d]# vi /etc/nginx/conf.d/default.conf 

location /mystatus {
    stub_status;
}
</code></pre><ul>
<li>配置完以后我们检查语法，重载服务</li>
</ul>
<pre><code>[root@thpffcj conf.d]# nginx -t -c /etc/nginx/nginx.conf

[root@thpffcj conf.d]# nginx -s reload -c /etc/nginx/nginx.conf
</code></pre><ul>
<li>访问192.168.242.129/mystatus，可以看到显示的相关文字信息(192.168.242.129是我本机IP)</li>
</ul>
<pre><code>Active connections: 1 
server accepts handled requests
 5 5 4 
Reading: 0 Writing: 1 Waiting: 0 
</code></pre><hr>
<table>
<thead>
<tr>
<th style="text-align:left">编译选项</th>
<th style="text-align:left">&nbsp;&nbsp;作用</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">–with-http_random_index_module</td>
<td style="text-align:left">&nbsp;&nbsp;目录中选择一个随机主页</td>
</tr>
</tbody>
</table>
<p><strong>语法</strong></p>
<pre><code>Syntax: random_index on|off;
Default: random_index off
Context: location
</code></pre><ul>
<li>修改配置文件，在/opt/app/code下有几个随便写的html</li>
</ul>
<pre><code>location / {
    root /opt/app/code
    #root   /usr/share/nginx/html;
    random_index on;
    #index  index.html index.htm;
}
</code></pre><ul>
<li>我们选择主页192.168.242.129，并刷新，我们发现会显示code目录下不同的页面</li>
</ul>
<hr>
<table>
<thead>
<tr>
<th style="text-align:left">编译选项</th>
<th style="text-align:left">&nbsp;&nbsp;作用</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">–with-http_sub_module</td>
<td style="text-align:left">&nbsp;&nbsp;HTTP内容替换</td>
</tr>
</tbody>
</table>
<p><strong>语法</strong></p>
<pre><code>Syntax: sub_filter string replacement;
Default: -
Context: http, server, location

Syntax: sub_filter_once on|off;
Default: sub_filter_once on
Context: server, location
</code></pre><ul>
<li>我们先复制一份默认配置到backup目录下</li>
</ul>
<pre><code>[root@thpffcj conf.d]# cp ./default.conf /opt/backup/default.conf
</code></pre><ul>
<li>sub_filter是替换字符串，我们在code下网页中输出Thpffcj，我们替换成THPFFCJ</li>
</ul>
<pre><code>location / {
    root   /opt/app/code;
    index  index.html index.htm;
    sub_filter &apos;&lt;a&gt;Thpffcj&apos; &apos;&lt;a&gt;THPFFCJ&apos;;
}
</code></pre><ul>
<li>重启服务器并输入192.168.242.129/test.html发现显示的是THPFFCJ，如果发现没有替换，可能需要清理一下浏览器缓存</li>
</ul>
<pre><code>[root@thpffcj conf.d]# systemctl reload nginx
</code></pre><ul>
<li>sub_fileter_once是匹配第一个还是所有的字符串，这样就替换所有的Thpffcj</li>
</ul>
<pre><code>location / {
    root   /opt/app/code;
    index  index.html index.htm;
    sub_filter &apos;&lt;a&gt;Thpffcj&apos; &apos;&lt;a&gt;THPFFCJ&apos;;
    sub_fileter_once off;
}
</code></pre><h3 id="7-Nginx的请求限制"><a href="#7-Nginx的请求限制" class="headerlink" title="7. Nginx的请求限制"></a>7. Nginx的请求限制</h3><ul>
<li>连接频率限制 - limit_conn_module</li>
<li>请求频率限制 - limit_req_module</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:left">HTTP协议版本</th>
<th style="text-align:left">&nbsp;&nbsp;连接关系</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">HTTP1.0</td>
<td style="text-align:left">&nbsp;&nbsp;TCP不能复用</td>
</tr>
<tr>
<td style="text-align:left">HTTP1.1</td>
<td style="text-align:left">&nbsp;&nbsp;顺序性TCP复用</td>
</tr>
<tr>
<td style="text-align:left">HTTP2.0</td>
<td style="text-align:left">&nbsp;&nbsp;多路复用TCP复用</td>
</tr>
</tbody>
</table>
<ul>
<li>HTTP请求建立在一次TCP连接基础上</li>
<li>一次TCP请求至少产生一次HTTP请求</li>
</ul>
<p><strong>语法</strong></p>
<pre><code>Syntax: limit_conn_zone key zone=name:size;
Default: -
Context: http

Syntax: limit_zone zone number;
Default: -
Context: http, server, location

Syntax: limit_req_zone key zone=name:size rate=rate;
Default: -
Context: http

Syntax: limit_req_zone=name [burst=number] [nodelay];
Default: -
Context: http, server, location
</code></pre><ul>
<li>修改配置文件限制请求，我们打开默认配置，首先我们都需要先定义zone，我们事先申请了conn_zone和req_zone。remote_addr是客户端的地址，binary_remote_addr和remote_addr基本一样，但对于1M的空间，存储remote_addr要比binary_remote_addr多十个字节，为了节省空间我们通常使用binary_remote_addr</li>
</ul>
<pre><code>limit_conn_zone $binary_remote_addr zone=conn_zone:1m;
limit_req_zone $binary_remote_addr zone=req_zone:1m rate=1r/s;

server {
    listen       80;
    server_name  localhost;

#charset koi8-r;
#access_log  /var/log/nginx/host.access.log  main;

location / {
    root   /usr/share/nginx/html;
    #limit_conn conn_zone 1;
    #limit_req zone=req_zone burst=3 nodelay;
    #limit_req zone=req_zone burst=3;
    limit_req zone=req_zone;
    index  index.html index.htm;
}
</code></pre><ul>
<li>重新加载配置文件，然后我们借助一个压力测试工具ab，-n表示发起的请求数，-c是同时并发的请求</li>
</ul>
<pre><code>[Thpffcj@thpffcj ~]$ ab -n 20 -c 20 http://192.168.242.129/index.html
</code></pre><ul>
<li>打开我们的error.log，会发现很多limiting request打到日志里去了</li>
</ul>
<pre><code>[root@thpffcj nginx]# tail -f /var/log/nginx/error.log

2017/12/13 19:24:58 [error] 5180#5180: *61 limiting requests, excess: 3.985 by zone &quot;req_zone&quot;, client: 192.168.242.129, server: localhost, request: &quot;GET /index.html HTTP/1.0&quot;, host: &quot;192.168.242.129&quot;
2017/12/13 19:24:58 [error] 5180#5180: *62 limiting requests, excess: 3.985 by zone &quot;req_zone&quot;, client: 192.168.242.129, server: localhost, request: &quot;GET /index.html HTTP/1.0&quot;, host: &quot;192.168.242.129&quot;
...
</code></pre><ul>
<li>我们可以注释掉这行配置，打开其他配置进行测试</li>
</ul>
<h3 id="8-Nginx的访问限制"><a href="#8-Nginx的访问限制" class="headerlink" title="8. Nginx的访问限制"></a>8. Nginx的访问限制</h3><ul>
<li>基于IP的访问控制 - http_access_module</li>
<li>基于用户的信任登录 - http_auth_basic_module</li>
</ul>
<p><strong>1. http_access_module语法</strong></p>
<pre><code>Syntax: allow address | CIDR | unix: | all;
Default: -
Context: http, server, location, limit_except

Syntax: deny address | CIDR | unix: | all;
Default: -
Context: http, server, location, limit_except
</code></pre><ul>
<li>我们演示一下access_module，我们从现在开始，每次演示使用一个新的配置文件(注意保存默认配置到某个目录以便出错无法解决恢复默认配置)</li>
</ul>
<pre><code>[root@thpffcj conf.d]# mv default.conf access_mod.conf
</code></pre><ul>
<li><p>首先我们需要查询自己的ip(不是服务器的ip，是指电脑出口的ip)，我们可以通过 <a href="http://www.ip138.com/" target="_blank" rel="noopener">http://www.ip138.com/</a> 查询</p>
</li>
<li><p>我们在location下做访问控制，只会对一个location下的访问进行限制，我们新建一个location，匹配根目录下以admin开头的</p>
</li>
<li>不允许自己的访问，检查配置并重新加载服务，输入192.168.242.129/admin.html返回了403</li>
</ul>
<pre><code>location ~ ^/admin.html {
    root /opt/app/code;
    deny 36.152.24.156;
    allow all;
    index  index.html index.htm;
}
</code></pre><ul>
<li>同样我们可以配置允许什么IP访问</li>
</ul>
<pre><code>location / {
    root /opt/app/code;
    allow 36.152.24.156;
    deny all;
    index  index.html index.htm;
}
</code></pre><p><strong>2. http_access_module的局限性</strong></p>
<ul>
<li>准确定不高，用户和服务中间可能有CDN，nginx,7层协议等</li>
<li>方法一：采用别的HTTP头信息访问控制，如HTTP_X_FORWARD_FOR</li>
<li>方法二：结合geo模块</li>
<li>方法三：通过HTTP自定义变量传递</li>
</ul>
<p><strong>3. http_auth_basic_module语法</strong></p>
<pre><code>Syntax: auth_basic string|off;
Default: auth_basic string off
Context: server, location, limit_except

Syntax: auth_basic_user_file file;
Default: -
Context: server, location, limit_except
</code></pre><ul>
<li>使用htpasswd生成存密码文件</li>
</ul>
<pre><code>[root@thpffcj nginx]# htpasswd -c ./auth_conf Thpffcj
New password: 
Re-type new password: 
Adding password for user Thpffcj

[root@thpffcj nginx]# ls
auth_conf  fastcgi_params  koi-win     modules     scgi_params   win-utf
conf.d     koi-utf         mime.types  nginx.conf  uwsgi_params

[root@thpffcj nginx]# more auth_conf 
Thpffcj:$apr1$EW1JG4oO$oNhLW7TuNqzNxm1Ni0n7.0
</code></pre><ul>
<li>修改配置文件</li>
</ul>
<pre><code>location ^/admin.html {
    root   /opt/app/code;
    auth_basic &quot;Auth access test input your password&quot;;
    auth_basic_user_file /etc/nginx/auth_conf;
    index  index.html index.htm;
}
</code></pre><ul>
<li>检查配置并重新加载服务，输入192.168.242.129/admin.html，输入用户名和密码后可以正常访问。</li>
</ul>
<p><strong>4. http_auth_basic_module局限性</strong></p>
<ul>
<li>用户信息依赖文件格式</li>
<li>操作管理机械，效率低下</li>
<li>解决方案：Nginx结合LUA实现高效验证</li>
<li>Nginx和LDAP打通，利用nginx-auth-ldap模块</li>
</ul>

            <div class="clearfix"></div>
            <hr class="nogutter">
        </div>
        <nav class="pagination" role="pagination">
    
    <a class="pull-left" href="/2017/12/06/JSP-Tag-Learning/" style="float: left;">
        ← JSP 标签学习(未完)
    </a>
    
    
    <a class="pull-right" href="/2017/11/25/Object-Oriented-Software-C onstruction/">
        面向对象软件构造 →
    </a>
    
</nav>

        <div class="duoshuo">


</div>
    </div>
</section>


      
<!-- ============================ Footer =========================== -->

<footer>
    <div class="container">
            <div class="copy">
				<span id="busuanzi_container_site_pv">
					本站总访问量<span id="busuanzi_value_site_pv"></span>次
				</span>	
                <p>
                    &copy; 2014<script>new Date().getFullYear()>2010&&document.write("-"+new Date().getFullYear());</script>, Content By Thpffcj.
                </p>
                <p>私は再び1日満たすためにあなたとの重要な人々を望みます</p>
            </div>
            <div class="social">
                <ul>
                    
                    <li><a href="https://github.com/" title="Github" target="_blank"><i class="icon-github"></i></a>&nbsp;</li>
                    
                    
                    <li><a href="https://twitter.com/" title="Twitter" target="_blank"><i class="icon-twitter"></i></a>&nbsp;</li>
                    
                    
                    <li><a href="https://www.facebook.com/" title="Facebook" target="_blank"><i class="icon-facebook"></i></a>&nbsp;</li>
                    
                    
                    <li><a href="https://google.com/" title="Google-Plus" target="_blank"><i class="icon-google-plus"></i></a>&nbsp;</li>
                    
                    
                    <li><a href="http://weibo.com/" title="Sina-Weibo" target="_blank"><i class="icon-sina-weibo"></i></a>&nbsp;</li>
                    
                </ul>
            </div>
            <div class="clearfix"> </div>
        </div>
</footer>

<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<!-- ============================ END Footer =========================== -->

      <!-- Load our scripts -->
<!-- Resizable 'on-demand' full-height hero -->
<script type="text/javascript">
    var resizeHero = function () {
        var hero = $(".cover,.heightblock"),
            window1 = $(window);
        hero.css({
            "height": window1.height()
        });
    };

    resizeHero();

    $(window).resize(function () {
        resizeHero();
    });
</script>
<script src="/js/plugins.min.js"></script><!-- Bootstrap core and concatenated plugins always load here -->
<script src="/js/jquery.flexslider-min.js"></script><!-- Flexslider plugin -->
<script src="/js/scripts.js"></script><!-- Theme scripts -->


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$('#intro').find('img').each(function(){
  var alt = this.alt;

  if (alt){
    $(this).after('<span class="caption" style="display:none">' + alt + '</span>');
  }

  $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox" rel="gallery" />');
});
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>

<!-- Initiate flexslider plugin -->
<script type="text/javascript">
    $(document).ready(function($) {
      (function(){
        console.log('font');
        var getCss = function(path) {
          var head = document.getElementsByTagName('head')[0];
          link = document.createElement('link');
          link.href = path;
          link.rel = 'stylesheet';
          link.type = 'text/css';
          head.appendChild(link);
        };
        getCss('https://fonts.googleapis.com/css?family=Montserrat:400,700');
        getCss('https://fonts.googleapis.com/css?family=Open+Sans:400,600');
      })();
      $('.flexslider').flexslider({
        animation: "fade",
        prevText: "",
        nextText: "",
        directionNav: true
      });
    });
</script>

</body>
</html>
